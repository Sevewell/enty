{% extends "base.html" %}

{% block title %}ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>âœ¨ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ</h1>
                <div>
                    <a href="{{ url_for('instances_list') }}" class="btn btn-secondary">
                        â† ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸€è¦§ã«æˆ»ã‚‹
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ</h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="create-entity-form">
                        <!-- åŸºæœ¬æƒ…å ± -->
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2">åŸºæœ¬æƒ…å ±</h6>
                            
                            <div class="mb-3">
                                <label for="title" class="form-label">
                                    <strong>ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å</strong> <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="title" name="title" 
                                       placeholder="ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" 
                                       maxlength="200" required>
                                <div class="form-text">æœ€å¤§200æ–‡å­—ã¾ã§å…¥åŠ›ã§ãã¾ã™ã€‚</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="class_id" class="form-label">
                                    <strong>ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¯ãƒ©ã‚¹</strong> <span class="text-danger">*</span>
                                </label>
                                <select class="form-control" id="class_id" name="class_id" required onchange="loadAttributeForm()">
                                    <option value="">ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¯ãƒ©ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                                    {% for entity_type in entity_types %}
                                    <option value="{{ entity_type.identifier }}" 
                                            {% if selected_type and (selected_type|int) == entity_type.identifier %}selected{% endif %}>
                                        {{ entity_type.title }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">ä½œæˆã™ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚¯ãƒ©ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
                            </div>
                            
                            <div class="row">
                                <div class="col-6">
                                    <label for="date_in" class="form-label">
                                        <strong>æœ‰åŠ¹æ—¥</strong>
                                    </label>
                                    <input type="date" class="form-control" id="date_in" name="date_in">
                                    <div class="form-text">ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æœ‰åŠ¹é–‹å§‹æ—¥ï¼ˆä»»æ„ï¼‰</div>
                                </div>
                                <div class="col-6">
                                    <label for="date_out" class="form-label">
                                        <strong>ç„¡åŠ¹æ—¥</strong>
                                    </label>
                                    <input type="date" class="form-control" id="date_out" name="date_out">
                                    <div class="form-text">ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æœ‰åŠ¹çµ‚äº†æ—¥ï¼ˆä»»æ„ï¼‰</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å±æ€§å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå‹•çš„ç”Ÿæˆï¼‰ -->
                        <div id="attributes-section" {% if not attribute_metas %}style="display: none;"{% endif %}>
                            <h6 class="text-primary border-bottom pb-2">å±æ€§å€¤</h6>
                            <div id="attribute-fields">
                                {% if attribute_metas %}
                                    {% for attr_meta in attribute_metas %}
                                    <div class="mb-3 attribute-field" data-type="{{ attr_meta.data_type }}">
                                        <label for="attr_{{ attr_meta.identifier }}" class="form-label">
                                            <strong>{{ attr_meta.title }}</strong>
                                            {% if attr_meta.data_type == 'required' %}<span class="text-danger">*</span>{% endif %}
                                        </label>
                                        
                                        {% if attr_meta.data_type == 'TEXT' %}
                                            <input type="text" class="form-control" 
                                                   id="attr_{{ attr_meta.identifier }}" 
                                                   name="attr_{{ attr_meta.identifier }}" 
                                                   placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                                        {% elif attr_meta.data_type == 'NUMBER' %}
                                            <input type="number" class="form-control" 
                                                   id="attr_{{ attr_meta.identifier }}" 
                                                   name="attr_{{ attr_meta.identifier }}" 
                                                   placeholder="æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                                        {% elif attr_meta.data_type == 'DATE' %}
                                            <input type="date" class="form-control" 
                                                   id="attr_{{ attr_meta.identifier }}" 
                                                   name="attr_{{ attr_meta.identifier }}">
                                        {% elif attr_meta.data_type == 'ENTITY' %}
                                            <select class="form-control entity-select" 
                                                    id="attr_{{ attr_meta.identifier }}" 
                                                    name="attr_{{ attr_meta.identifier }}">
                                                <option value="">ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                                                <!-- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ä¸€è¦§ã¯ JavaScript ã§å‹•çš„ã«èª­ã¿è¾¼ã¿ -->
                                            </select>
                                        {% else %}
                                            <input type="text" class="form-control" 
                                                   id="attr_{{ attr_meta.identifier }}" 
                                                   name="attr_{{ attr_meta.identifier }}" 
                                                   placeholder="å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                                        {% endif %}
                                        
                                        <div class="form-text">
                                            ãƒ‡ãƒ¼ã‚¿å‹: {{ attr_meta.data_type }}
                                            {% if attr_meta.data_type == 'required' %}ï¼ˆå¿…é ˆé …ç›®ï¼‰{% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{{ url_for('instances_list') }}" class="btn btn-secondary">
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </a>
                            <button type="submit" class="btn btn-primary">
                                âœ… ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒ˜ãƒ«ãƒ—æƒ…å ±ï¼‰ -->
        <div class="col-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">ğŸ’¡ ä½œæˆã®ãƒ’ãƒ³ãƒˆ</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-primary">ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å</h6>
                        <p class="text-muted text-small">
                            ä¸€æ„ã§åˆ†ã‹ã‚Šã‚„ã™ã„åå‰ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚å¾Œã‹ã‚‰å¤‰æ›´ã‚‚å¯èƒ½ã§ã™ã€‚
                        </p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¯ãƒ©ã‚¹</h6>
                        <p class="text-muted text-small">
                            ã‚¯ãƒ©ã‚¹ã‚’é¸æŠã™ã‚‹ã¨ã€ãã®ã‚¯ãƒ©ã‚¹ã«å®šç¾©ã•ã‚ŒãŸå±æ€§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                        </p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">å±æ€§å€¤</h6>
                        <p class="text-muted text-small">
                            å±æ€§å€¤ã¯ä»»æ„ã§ã™ã€‚å¾Œã‹ã‚‰è¿½åŠ ãƒ»ç·¨é›†ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
                        </p>
                    </div>
                    
                    <div class="mb-0">
                        <h6 class="text-primary">æ—¥ä»˜</h6>
                        <p class="text-muted text-small">
                            æœ‰åŠ¹æ—¥ãƒ»ç„¡åŠ¹æ—¥ã¯ç®¡ç†ç”¨ã§ã™ã€‚ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æœ‰åŠ¹æœŸé–“ã‚’è¨­å®šã§ãã¾ã™ã€‚
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">ğŸ“Š ç¾åœ¨ã®çŠ¶æ³</h6>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <div class="text-muted">
                            <div style="font-size: 2rem;">ğŸ’¼</div>
                            <p class="mb-1">ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¯ãƒ©ã‚¹æ•°</p>
                            <h4 class="text-primary">{{ entity_types|length }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function loadAttributeForm() {
    const classId = document.getElementById('class_id').value;
    const attributesSection = document.getElementById('attributes-section');
    const attributeFields = document.getElementById('attribute-fields');
    
    if (!classId) {
        attributesSection.style.display = 'none';
        return;
    }
    
    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å±æ€§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('type', classId);
    window.location.href = currentUrl.toString();
}

// ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
async function loadEntities() {
    try {
        const response = await fetch('/api/entities');
        const entities = await response.json();
        
        // å…¨ã¦ã®ENTITYå‹ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è¿½åŠ 
        const entitySelects = document.querySelectorAll('.entity-select');
        entitySelects.forEach(select => {
            // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆåˆæœŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»¥å¤–ï¼‰
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è¿½åŠ 
            entities.forEach(entity => {
                const option = document.createElement('option');
                option.value = entity.identifier;
                option.textContent = `${entity.title} (${entity.type_name})`;
                select.appendChild(option);
            });
        });
        
    } catch (error) {
        console.error('Error loading entities:', error);
    }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
document.addEventListener('DOMContentLoaded', function() {
    loadEntities();
});

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
document.getElementById('create-entity-form').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    const classId = document.getElementById('class_id').value;
    
    if (!title) {
        e.preventDefault();
        alert('ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        document.getElementById('title').focus();
        return;
    }
    
    if (!classId) {
        e.preventDefault();
        alert('ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¯ãƒ©ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        document.getElementById('class_id').focus();
        return;
    }
    
    // å¿…é ˆå±æ€§ã®ãƒã‚§ãƒƒã‚¯
    const requiredFields = document.querySelectorAll('.attribute-field[data-type="required"] input, .attribute-field[data-type="required"] textarea');
    for (let field of requiredFields) {
        if (!field.value.trim()) {
            e.preventDefault();
            alert(`å¿…é ˆé …ç›®ã€Œ${field.previousElementSibling.textContent}ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
            field.focus();
            return;
        }
    }
});

// æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆ¶å¾¡
document.getElementById('date_in').addEventListener('change', function() {
    const dateOut = document.getElementById('date_out');
    if (this.value) {
        dateOut.min = this.value;
    } else {
        dateOut.removeAttribute('min');
    }
});

document.getElementById('date_out').addEventListener('change', function() {
    const dateIn = document.getElementById('date_in');
    if (this.value) {
        dateIn.max = this.value;
    } else {
        dateIn.removeAttribute('max');
    }
});
</script>
{% endblock %}
