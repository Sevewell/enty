{% extends "base.html" %}

{% block title %}„Ç§„É≥„Çπ„Çø„É≥„Çπ‰ΩúÊàê{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>‚ú® „Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£„Ç§„É≥„Çπ„Çø„É≥„Çπ‰ΩúÊàê</h1>
                <div>
                    <a href="{{ url_for('instances_list') }}" class="btn btn-secondary">
                        ‚Üê „Ç§„É≥„Çπ„Çø„É≥„Çπ‰∏ÄË¶ß„Å´Êàª„Çã
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Êñ∞„Åó„ÅÑ„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰ΩúÊàê</h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="create-entity-form">
                        <!-- Âü∫Êú¨ÊÉÖÂ†± -->
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2">Âü∫Êú¨ÊÉÖÂ†±</h6>
                            
                            <div class="mb-3">
                                <label for="title" class="form-label">
                                    <strong>„Ç§„É≥„Çπ„Çø„É≥„ÇπÂêç</strong> <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="title" name="title" 
                                       placeholder="„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" 
                                       maxlength="200" required>
                                <div class="form-text">ÊúÄÂ§ß200ÊñáÂ≠ó„Åæ„ÅßÂÖ•Âäõ„Åß„Åç„Åæ„Åô„ÄÇ</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="class_id" class="form-label">
                                    <strong>„Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£„ÇØ„É©„Çπ</strong> <span class="text-danger">*</span>
                                </label>
                                <select class="form-control" id="class_id" name="class_id" required onchange="loadAttributeForm()">
                                    <option value="">„Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£„ÇØ„É©„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                    {% for entity_type in entity_types %}
                                    <option value="{{ entity_type.identifier }}" 
                                            {% if selected_type and (selected_type|int) == entity_type.identifier %}selected{% endif %}>
                                        {{ entity_type.title }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">‰ΩúÊàê„Åô„Çã„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅÆ„ÇØ„É©„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
                            </div>
                            
                            <div class="row">
                                <div class="col-6">
                                    <label for="date_in" class="form-label">
                                        <strong>ÊúâÂäπÊó•</strong>
                                    </label>
                                    <input type="date" class="form-control" id="date_in" name="date_in">
                                    <div class="form-text">„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅÆÊúâÂäπÈñãÂßãÊó•Ôºà‰ªªÊÑèÔºâ</div>
                                </div>
                                <div class="col-6">
                                    <label for="date_out" class="form-label">
                                        <strong>ÁÑ°ÂäπÊó•</strong>
                                    </label>
                                    <input type="date" class="form-control" id="date_out" name="date_out">
                                    <div class="form-text">„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅÆÊúâÂäπÁµÇ‰∫ÜÊó•Ôºà‰ªªÊÑèÔºâ</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Â±ûÊÄßÂÖ•Âäõ„Éï„Ç©„Éº„É†ÔºàÂãïÁöÑÁîüÊàêÔºâ -->
                        <div id="attributes-section" {% if not attribute_metas %}style="display: none;"{% endif %}>
                            <h6 class="text-primary border-bottom pb-2">Â±ûÊÄßÂÄ§</h6>
                            <div id="attribute-fields">
                                {% if attribute_metas %}
                                    {% for attr_meta in attribute_metas %}
                                    <div class="mb-3 attribute-field" data-type="{{ attr_meta.data_type }}">
                                        <label for="attr_{{ attr_meta.identifier }}" class="form-label">
                                            <strong>{{ attr_meta.title }}</strong>
                                            {% if attr_meta.data_type == 'required' %}<span class="text-danger">*</span>{% endif %}
                                        </label>
                                        
                                        {% if attr_meta.data_type == 'TEXT' %}
                                            <input type="text" class="form-control" 
                                                   id="attr_{{ attr_meta.identifier }}" 
                                                   name="attr_{{ attr_meta.identifier }}" 
                                                   placeholder="„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
                                        {% elif attr_meta.data_type == 'NUMBER' %}
                                            <input type="number" class="form-control" 
                                                   id="attr_{{ attr_meta.identifier }}" 
                                                   name="attr_{{ attr_meta.identifier }}" 
                                                   placeholder="Êï∞ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
                                        {% elif attr_meta.data_type == 'DATE' %}
                                            <input type="date" class="form-control" 
                                                   id="attr_{{ attr_meta.identifier }}" 
                                                   name="attr_{{ attr_meta.identifier }}">
                                        {% elif attr_meta.data_type == 'ENTITY' %}
                                            <select class="form-control entity-select" 
                                                    id="attr_{{ attr_meta.identifier }}" 
                                                    name="attr_{{ attr_meta.identifier }}">
                                                <option value="">„Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                                <!-- „Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£‰∏ÄË¶ß„ÅØ JavaScript „ÅßÂãïÁöÑ„Å´Ë™≠„ÅøËæº„Åø -->
                                            </select>
                                        {% else %}
                                            <input type="text" class="form-control" 
                                                   id="attr_{{ attr_meta.identifier }}" 
                                                   name="attr_{{ attr_meta.identifier }}" 
                                                   placeholder="ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
                                        {% endif %}
                                        
                                        <div class="form-text">
                                            „Éá„Éº„ÇøÂûã: {{ attr_meta.data_type }}
                                            {% if attr_meta.data_type == 'required' %}ÔºàÂøÖÈ†àÈ†ÖÁõÆÔºâ{% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- ÈÄÅ‰ø°„Éú„Çø„É≥ -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{{ url_for('instances_list') }}" class="btn btn-secondary">
                                „Ç≠„É£„É≥„Çª„É´
                            </a>
                            <button type="submit" class="btn btn-primary">
                                ‚úÖ „Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰ΩúÊàê
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- „Çµ„Ç§„Éâ„Éê„ÉºÔºà„Éò„É´„ÉóÊÉÖÂ†±Ôºâ -->
        <div class="col-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">üí° ‰ΩúÊàê„ÅÆ„Éí„É≥„Éà</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-primary">„Ç§„É≥„Çπ„Çø„É≥„ÇπÂêç</h6>
                        <p class="text-muted text-small">
                            ‰∏ÄÊÑè„ÅßÂàÜ„Åã„Çä„ÇÑ„Åô„ÅÑÂêçÂâç„Çí„Å§„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂæå„Åã„ÇâÂ§âÊõ¥„ÇÇÂèØËÉΩ„Åß„Åô„ÄÇ
                        </p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">„Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£„ÇØ„É©„Çπ</h6>
                        <p class="text-muted text-small">
                            „ÇØ„É©„Çπ„ÇíÈÅ∏Êäû„Åô„Çã„Å®„ÄÅ„Åù„ÅÆ„ÇØ„É©„Çπ„Å´ÂÆöÁæ©„Åï„Çå„ÅüÂ±ûÊÄß„Éï„Ç£„Éº„É´„Éâ„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ
                        </p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">Â±ûÊÄßÂÄ§</h6>
                        <p class="text-muted text-small">
                            Â±ûÊÄßÂÄ§„ÅØ‰ªªÊÑè„Åß„Åô„ÄÇÂæå„Åã„ÇâËøΩÂä†„ÉªÁ∑®ÈõÜ„Åô„Çã„Åì„Å®„ÇÇÂèØËÉΩ„Åß„Åô„ÄÇ
                        </p>
                    </div>
                    
                    <div class="mb-0">
                        <h6 class="text-primary">Êó•‰ªò</h6>
                        <p class="text-muted text-small">
                            ÊúâÂäπÊó•„ÉªÁÑ°ÂäπÊó•„ÅØÁÆ°ÁêÜÁî®„Åß„Åô„ÄÇ„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅÆÊúâÂäπÊúüÈñì„ÇíË®≠ÂÆö„Åß„Åç„Åæ„Åô„ÄÇ
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">üìä ÁèæÂú®„ÅÆÁä∂Ê≥Å</h6>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <div class="text-muted">
                            <div style="font-size: 2rem;">üíº</div>
                            <p class="mb-1">„Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£„ÇØ„É©„ÇπÊï∞</p>
                            <h4 class="text-primary">{{ entity_types|length }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function loadAttributeForm() {
    const classId = document.getElementById('class_id').value;
    const attributesSection = document.getElementById('attributes-section');
    const attributeFields = document.getElementById('attribute-fields');
    
    if (!classId) {
        attributesSection.style.display = 'none';
        return;
    }
    
    // ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶Â±ûÊÄß„Éï„Ç£„Éº„É´„Éâ„ÇíË°®Á§∫
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('type', classId);
    window.location.href = currentUrl.toString();
}

// „Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„ÇÄÈñ¢Êï∞
async function loadEntities() {
    try {
        const response = await fetch('/api/entities');
        const entities = await response.json();
        
        // ÂÖ®„Å¶„ÅÆENTITYÂûã„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„Å´„Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£„ÇíËøΩÂä†
        const entitySelects = document.querySelectorAll('.entity-select');
        entitySelects.forEach(select => {
            // Êó¢Â≠ò„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„Çí„ÇØ„É™„Ç¢ÔºàÂàùÊúü„Ç™„Éó„Ç∑„Éß„É≥‰ª•Â§ñÔºâ
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // „Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£„ÇíËøΩÂä†
            entities.forEach(entity => {
                const option = document.createElement('option');
                option.value = entity.identifier;
                option.textContent = `${entity.title} (${entity.type_name})`;
                select.appendChild(option);
            });
        });
        
    } catch (error) {
        console.error('Error loading entities:', error);
    }
}

// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„Åø
document.addEventListener('DOMContentLoaded', function() {
    loadEntities();
});

// „Éï„Ç©„Éº„É†ÈÄÅ‰ø°Ââç„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
document.getElementById('create-entity-form').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    const classId = document.getElementById('class_id').value;
    
    if (!title) {
        e.preventDefault();
        alert('„Ç§„É≥„Çπ„Çø„É≥„ÇπÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        document.getElementById('title').focus();
        return;
    }
    
    if (!classId) {
        e.preventDefault();
        alert('„Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£„ÇØ„É©„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        document.getElementById('class_id').focus();
        return;
    }
    
    // ÂøÖÈ†àÂ±ûÊÄß„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
    const requiredFields = document.querySelectorAll('.attribute-field[data-type="required"] input, .attribute-field[data-type="required"] textarea');
    for (let field of requiredFields) {
        if (!field.value.trim()) {
            e.preventDefault();
            alert(`ÂøÖÈ†àÈ†ÖÁõÆ„Äå${field.previousElementSibling.textContent}„Äç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
            field.focus();
            return;
        }
    }
});

// Êó•‰ªò„Éï„Ç£„Éº„É´„Éâ„ÅÆÂà∂Âæ°
document.getElementById('date_in').addEventListener('change', function() {
    const dateOut = document.getElementById('date_out');
    if (this.value) {
        dateOut.min = this.value;
    } else {
        dateOut.removeAttribute('min');
    }
});

document.getElementById('date_out').addEventListener('change', function() {
    const dateIn = document.getElementById('date_in');
    if (this.value) {
        dateIn.max = this.value;
    } else {
        dateIn.removeAttribute('max');
    }
});
</script>
{% endblock %}
